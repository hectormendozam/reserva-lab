<!-- src/app/screens/dashboard/dashboard.component.html -->
<app-navbar></app-navbar>
<div class="container-fluid py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <button class="btn btn-outline-secondary me-2" (click)="goLabs()">
          Ver laboratorios
        </button>

        <button class="btn btn-primary me-2" (click)="goCreateReservation()">
          Nueva reserva
        </button>

        <button
          class="btn btn-outline-primary me-2"
          *ngIf="role === 'TECH' || role === 'ADMIN'"
          (click)="goCreateLoan()"
        >
          Nuevo préstamo
        </button>

        <button
          class="btn btn-outline-dark"
          *ngIf="role === 'ADMIN'"
          (click)="goReports()"
        >
          Reportes
        </button>
      </div>
    </div>
    <!-- Alerts (retrasos, mantenimiento, sin stock) -->
    <div
      class="alert alert-warning d-flex align-items-center mb-3"
      role="alert"
      *ngIf="alerts.length"
    >
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div class="flex-grow-1">
        <strong>Alertas:</strong>
        <span *ngFor="let a of alerts; let i = index">
          {{ a.text }} <span *ngIf="i < alerts.length - 1">·</span>
        </span>
      </div>
      <a class="btn btn-sm btn-outline-dark ms-3" (click)="goAlerts()"
        >Revisar</a
      >
    </div>

    <!-- Statistic cards -->
    <div class="row g-3 mb-4">
      <div class="col-sm-6 col-md-3" *ngFor="let s of stats">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex align-items-center">
            <div class="me-3">
              <div
                class="rounded-circle text-white d-flex align-items-center justify-content-center"
                [ngClass]="s.colorClass"
                style="width: 56px; height: 56px"
              >
                <i class="bi" [ngClass]="s.icon" style="font-size: 1.25rem"></i>
              </div>
            </div>
            <div>
              <div class="fw-bold fs-5">{{ s.value }}</div>
              <div class="text-muted small">
                {{ s.title }} · {{ s.subtitle }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent reservations -->
    <div class="card shadow-sm">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h6 class="mb-0">Reservas recientes de laboratorio</h6>
        <a routerLink="/reservations" class="small">Ver todas</a>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead class="table-light">
              <tr>
                <th>Laboratorio</th>
                <th>Usuario</th>
                <th>Inicio</th>
                <th>Fin</th>
                <th>Estado</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of recentReservations">
                <td>{{ r.lab }}</td>
                <td>{{ r.user }}</td>
                <td>{{ r.start }}</td>
                <td>{{ r.end }}</td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="{
                      'bg-success': r.status === 'Confirmada',
                      'bg-warning text-dark': r.status === 'Pendiente',
                      'bg-danger': r.status === 'Cancelada'
                    }"
                    >{{ r.status }}</span
                  >
                </td>
                <td class="text-end">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    (click)="viewReservation(r.id)"
                  >
                    <i class="bi bi-eye"></i> Ver
                  </button>
                </td>
              </tr>
              <tr *ngIf="recentReservations.length === 0">
                <td colspan="6" class="text-center py-3 text-muted">
                  No hay reservas recientes
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Loans summary -->
    <div class="card shadow-sm mt-4">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h6 class="mb-0">Préstamos de equipo</h6>
        <div class="small text-muted">
          Pendientes: <strong>{{ loansSummary.pending }}</strong> · Próximos a
          vencer (48h): <strong>{{ loansSummary.dueSoon }}</strong> ·
          Retrasados:
          <strong class="text-danger">{{ loansSummary.late }}</strong>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead class="table-light">
              <tr>
                <th>Equipo</th>
                <th>Usuario</th>
                <th>Fecha préstamo</th>
                <th>Vence</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let l of recentLoans">
                <td>{{ l.equipment }}</td>
                <td>{{ l.user }}</td>
                <td>{{ l.loanDate }}</td>
                <td>
                  {{ l.dueDate }}
                  <span *ngIf="l.isLate" class="badge bg-danger ms-1"
                    >Tarde</span
                  >
                  <span
                    *ngIf="l.dueSoon && !l.isLate"
                    class="badge bg-warning text-dark ms-1"
                    >48h</span
                  >
                </td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="{
                      'bg-secondary': l.status === 'Pendiente',
                      'bg-success':
                        l.status === 'Aprobado' || l.status === 'Devuelto',
                      'bg-danger': l.status === 'Tarde' || l.status === 'Dañado'
                    }"
                  >
                    {{ l.status }}
                  </span>
                </td>
                <td class="text-end">
                  <button
                    class="btn btn-sm btn-outline-primary me-2"
                    (click)="viewLoan(l.id)"
                  >
                    <i class="bi bi-eye"></i> Ver
                  </button>
                  <button
                    class="btn btn-sm btn-outline-success"
                    *ngIf="canRegisterReturn"
                    (click)="registerReturn(l.id)"
                  >
                    <i class="bi bi-box-arrow-in-down"></i> Registrar devolución
                  </button>
                </td>
              </tr>
              <tr *ngIf="recentLoans.length === 0">
                <td colspan="6" class="text-center py-3 text-muted">
                  No hay préstamos
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
